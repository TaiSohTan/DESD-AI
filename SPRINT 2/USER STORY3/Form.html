<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Claim Document Upload</title>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
</head>
<body class="container mt-5">
  <h2>Claim Document Upload</h2>

  <form id="claimForm">
    <div class="mb-3">
      <label for="fileInput" class="form-label">Upload File (PDF/JPG/PNG)</label>
      <input
        type="file"
        class="form-control"
        id="fileInput"
        name="file"
        accept=".pdf, .jpg, .jpeg, .png"
        required
      />
    </div>

    <div class="mb-3">
      <label for="description" class="form-label">Claim Description (Optional)</label>
      <textarea
        class="form-control"
        id="description"
        name="description"
        rows="3"
      ></textarea>
    </div>

    <input type="hidden" id="userId" name="userId" value="123456" />

    <button type="submit" class="btn btn-primary" id="submitBtn">Submit</button>
    <div id="statusMsg" class="mt-3"></div>
  </form>

  <script>
    const form = document.getElementById('claimForm');
    const fileInput = document.getElementById('fileInput');
    const statusMsg = document.getElementById('statusMsg');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const file = fileInput.files[0];

      const validTypes = ['application/pdf', 'image/jpeg', 'image/png'];
      if (!validTypes.includes(file.type)) {
        alert('Only PDF, JPG, or PNG files are allowed!');
        return;
      }
      if (file.size > 10 * 1024 * 1024) {
        alert('File size must not exceed 10MB!');
        return;
      }

      const description = document.getElementById('description').value.trim();
      if (!description) {
        const proceed = confirm('You have not entered a description. Do you want to continue?');
        if (!proceed) return;
      }

      const formData = new FormData(form);
      statusMsg.innerHTML = "Uploading, please wait...";
      submitBtn.disabled = true;

      try {
        const response = await fetch("http://127.0.0.1:8000/upload-claim", {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (response.ok) {
          statusMsg.innerHTML = `
            <div class="alert alert-success">
              Upload successful!<br>
              <strong>Prediction ID:</strong> ${result.predictionId}<br>
              <strong>Predicted Settlement Value:</strong> $${result.prediction.toFixed(2)}<br>
              <strong>Confidence Level:</strong> ${(result.confidence * 100).toFixed(1)}%
              <br><br>

              <!-- Accept / Reject buttons only -->
              <button id="acceptBtn" class="btn btn-success">Accept</button>
              <button id="rejectBtn" class="btn btn-danger">Reject</button>
            </div>`;

          const acceptBtn = document.getElementById('acceptBtn');
          const rejectBtn = document.getElementById('rejectBtn');

          acceptBtn.addEventListener('click', () => {
            alert("You have accepted the prediction!");
          });

          rejectBtn.addEventListener('click', () => {
            window.location.href = `feedback.html?predictionId=${result.predictionId}`;
          });
        } else {
          statusMsg.innerHTML = `<div class="alert alert-danger">Upload failed: ${result.detail || 'Unknown error.'}</div>`;
        }
      } catch (error) {
        console.error(error);
        statusMsg.innerHTML = '<div class="alert alert-danger">Upload failed. Please try again later.</div>';
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>