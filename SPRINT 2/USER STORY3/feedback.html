<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Prediction Feedback</title>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
  />
</head>
<body class="container mt-5">
  <h2>Submit Feedback on Prediction</h2>

  <form id="feedbackForm">
    <!-- Hidden or read-only field for Prediction ID -->
    <div class="mb-3">
      <label for="predictionId" class="form-label">Prediction ID</label>
      <input
        type="text"
        class="form-control"
        id="predictionId"
        name="predictionId"
        value=""
        required
        readonly
      />
    </div>

    <!-- Feedback Text -->
    <div class="mb-3">
      <label for="feedbackText" class="form-label">Your Feedback</label>
      <textarea
        class="form-control"
        id="feedbackText"
        name="feedbackText"
        rows="3"
        placeholder="Explain why you are not satisfied, or provide suggestions..."
      ></textarea>
    </div>

    <!-- Optional Satisfaction Rating -->
    <div class="mb-3">
      <label for="rating" class="form-label">Satisfaction Rating (1-5)</label>
      <select class="form-select" id="rating" name="rating">
        <option value="">--Select--</option>
        <option value="1">1 - Very Dissatisfied</option>
        <option value="2">2 - Unsatisfied</option>
        <option value="3">3 - Neutral</option>
        <option value="4">4 - Satisfied</option>
        <option value="5">5 - Very Satisfied</option>
      </select>
    </div>

    <!-- Hidden field: User ID (if applicable) -->
    <input type="hidden" id="userId" name="userId" value="123456" />

    <button type="submit" class="btn btn-primary" id="submitBtn">
      Submit Feedback
    </button>
    <div id="statusMsg" class="mt-3"></div>
  </form>

  <script>
    function getQueryParams() {
      const params = {};
      const queryString = window.location.search;
      if (!queryString) return params;

      const pairs = queryString.substring(1).split('&');
      for (let p of pairs) {
        const [key, val] = p.split('=');
        params[key] = decodeURIComponent(val);
      }
      return params;
    }

    const feedbackForm = document.getElementById('feedbackForm');
    const statusMsg = document.getElementById('statusMsg');
    const submitBtn = document.getElementById('submitBtn');
    const predictionIdInput = document.getElementById('predictionId');

    window.addEventListener('DOMContentLoaded', () => {
      const qs = getQueryParams();
      if (qs.predictionId) {
        predictionIdInput.value = qs.predictionId;
      }
    });

    feedbackForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      statusMsg.innerHTML = `<div class="alert alert-info">Submitting feedback...</div>`;

      try {
        const formData = new FormData(feedbackForm);
        const response = await fetch('http://127.0.0.1:8000/submit-feedback', {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          const errorText = await response.text();
          statusMsg.innerHTML = `<div class="alert alert-danger">Error: ${errorText}</div>`;
        } else {
          const result = await response.json();
          statusMsg.innerHTML = `
            <div class="alert alert-success">
              Feedback submitted successfully!<br>
              <strong>Feedback ID:</strong> ${result.feedbackId}
            </div>`;
        }
      } catch (error) {
        console.error(error);
        statusMsg.innerHTML = `<div class="alert alert-danger">
          Failed to submit feedback. Please try again later.
        </div>`;
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
